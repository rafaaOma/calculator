@using System.Linq.Expressions
@using NCalc;
@using System
@page "/calculator"
<div class="container">
     @if (!string.IsNullOrEmpty(erorrMassage)) //checking errorMassage fild has error massage
    {
        <div class="error-toast">@erorrMassage</div>
    }
    <div class="Calculator">
        <h3 class="title">Simple Calculator!</h3>
        <input type="text" class="display" @bind="display" readonly />
        <div class="buttons">
            <button class="number" @onclick="() => addNumber('7')">7</button>
            <button class="number" @onclick="() => addNumber('8')">8</button>
            <button class="number" @onclick="() => addNumber('9')">9</button>
            <button class="operation" @onclick="() => addOperation('+')">+</button>
                @* first row *@
            <button class="number" @onclick="() => addNumber('4')">4</button>
            <button class="number" @onclick="() => addNumber('5')">5</button>
            <button class="number" @onclick="() => addNumber('6')">6</button>
            <button class="operation" @onclick="() => addOperation('-')">-</button>
                @* second row *@
            <button class="number" @onclick="() => addNumber('1')">1</button>
            <button class="number" @onclick="() => addNumber('2')">2</button>
            <button class="number" @onclick="() => addNumber('3')">3</button>
            <button class="operation" @onclick="() => addOperation('*')">x</button>
                @* third row *@
            <button class="operation" @onclick="() => clearDisplay()">C</button>
            <button class="number" @onclick="() => addNumber('0')">0</button>
            <button class="operation" @onclick="() => calculateResult()">=</button>
            <button class="operation" @onclick="() => addOperation('/')">/</button>
                @* fourth row *@
        </div>
    </div>
</div>
@code{
    private string display = string.Empty;
    private string? erorrMassage;
    
    private async Task calculateResult()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(display) ||
            System.Text.RegularExpressions.Regex.IsMatch(display, @"[+\-*/]{2,}") ||
            display.StartsWith("+") || display.StartsWith("-") ||
            display.StartsWith("*") || display.StartsWith("/") ||
            display.EndsWith("+") || display.EndsWith("-") ||
            display.EndsWith("*") || display.EndsWith("/")) //chikeing wrong ex with -- or ++ or it ends with - or +
            {
              await  ShowError("Invalid expression.");
                return;
            }
            object? result = null;
        try
        {
            var e = new NCalc.Expression(display);
            result = e.Evaluate();
        }
        catch (Exception ex)
        {
            Console.WriteLine("NCalc Error: " + ex.Message);
            await ShowError("Calculation error.\nPlease check your input.");
            return;
        }

        display = result?.ToString() ?? "0";
    }
     catch (Exception ex)
    {
        // أي خطأ عام (خارج NCalc)
        Console.WriteLine("General Error: " + ex.Message);
        await ShowError("Unexpected error.\nPlease try again.");
    }
    }
      private async Task ShowError(string message)
    {
        erorrMassage = message;
        StateHasChanged(); // update UI

        await Task.Delay(4000); 

        erorrMassage = null; // hide massage after 2500ms
       await InvokeAsync(StateHasChanged) ;   
    }
    private void addNumber(char number)
    {
        display += number;
    }
    private void addOperation(char operation)
    {
     display += operation;
    }
    private void clearDisplay()
    {
        display = "";
    }
}